generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int              @id @default(autoincrement())
  nombre           String
  userName         String           @unique
  email            String           @unique
  password         String
  rol              Rol
  activo           Boolean
  deletedAt        DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  logs             Log[]
  lotes            Lote[]           @relation("UserLotes")
  modems           Modem[]
  registros        Registro[]
  registrosInsumos RegistroInsumo[]
}

model CatalogoSKU {
  id                  Int                   @id
  nombre              String                @unique
  skuItem             String?               @unique
  descripcion         String?
  inventarioCosmetico InventarioCosmetico[]
  lotes               Lote[]
  modems              Modem[]
  registrosInsumos    RegistroInsumo[]
}

model Lote {
  id            Int          @id @default(autoincrement())
  numero        String       @unique
  skuId         Int
  tipoLote      TipoLote     @default(ENTRADA)
  esScrap       Boolean      @default(false)
  motivoScrap   MotivoScrap?
  estado        EstadoLote   @default(EN_PROCESO)
  prioridad     Int          @default(5)
  responsableId Int
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?
  responsable   User         @relation("UserLotes", fields: [responsableId], references: [id])
  sku           CatalogoSKU  @relation(fields: [skuId], references: [id])
  modems        Modem[]      @relation("ModemsEnLote")
  modemsSalida  Modem[]      @relation("ModemsEnLoteSalida")
  registros     Registro[]
}

model Modem {
  id             Int           @id @default(autoincrement())
  sn             String        @unique
  skuId          Int
  estadoActualId Int
  faseActual     FaseProceso
  loteId         Int
  loteSalidaId   Int?
  responsableId  Int
  motivoScrap    MotivoScrap?
  detalleScrap   DetalleScrap?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  estadoActual   Estado        @relation(fields: [estadoActualId], references: [id])
  lote           Lote          @relation("ModemsEnLote", fields: [loteId], references: [id])
  loteSalida     Lote?         @relation("ModemsEnLoteSalida", fields: [loteSalidaId], references: [id])
  responsable    User          @relation(fields: [responsableId], references: [id])
  sku            CatalogoSKU   @relation(fields: [skuId], references: [id])
  registros      Registro[]
}

model Registro {
  id           Int            @id @default(autoincrement())
  sn           String
  fase         FaseProceso
  estado       EstadoRegistro
  motivoScrap  MotivoScrap?
  detalleScrap DetalleScrap?
  reparacion   String?
  userId       Int
  loteId       Int
  modemId      Int
  createdAt    DateTime       @default(now())
  lote         Lote           @relation(fields: [loteId], references: [id])
  modem        Modem          @relation(fields: [modemId], references: [id])
  user         User           @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([loteId])
  @@index([modemId])
}

model Log {
  id        Int      @id @default(autoincrement())
  accion    String
  entidad   String
  detalle   String?
  userId    Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Estado {
  id                  Int                @id @default(autoincrement())
  nombre              String             @unique
  descripcion         String?
  codigoInterno       String             @unique
  esFinal             Boolean            @default(false)
  requiereObservacion Boolean            @default(false)
  ordenDisplay        Int                @default(0)
  color               String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  modems              Modem[]
  transicionesDesde   TransicionEstado[] @relation("EstadoDesde")
  transicionesHacia   TransicionEstado[] @relation("EstadoHacia")
}

model InventarioCosmetico {
  id         Int         @id @default(autoincrement())
  skuId      Int
  tipoInsumo TipoInsumo
  cantidad   Int         @default(0)
  updatedAt  DateTime    @updatedAt
  sku        CatalogoSKU @relation(fields: [skuId], references: [id])

  @@unique([skuId, tipoInsumo])
  @@index([skuId])
}

model RegistroInsumo {
  id             Int            @id @default(autoincrement())
  tipoMovimiento TipoMovimiento
  tipoInsumo     TipoInsumo
  skuId          Int
  cantidad       Int
  responsableId  Int
  createdAt      DateTime       @default(now())
  responsable    User           @relation(fields: [responsableId], references: [id])
  sku            CatalogoSKU    @relation(fields: [skuId], references: [id])

  @@index([skuId])
  @@index([responsableId])
}

model TransicionEstado {
  id                  Int      @id @default(autoincrement())
  estadoDesdeId       Int
  estadoHaciaId       Int
  nombreEvento        String
  descripcion         String?
  requiereCantidad    Boolean  @default(false)
  requiereObservacion Boolean  @default(false)
  rolesPermitidos     String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  estadoDesde         Estado   @relation("EstadoDesde", fields: [estadoDesdeId], references: [id])
  estadoHacia         Estado   @relation("EstadoHacia", fields: [estadoHaciaId], references: [id])

  @@unique([estadoDesdeId, nombreEvento])
  @@index([estadoDesdeId])
  @@index([estadoHaciaId])
}

enum Rol {
  UAI
  UA
  UV
  UReg
  UTI
  UR
  UC
  UE
  UEN
}

enum EstadoRegistro {
  SN_OK
  SCRAP_COSMETICO
  SCRAP_ELECTRONICO
  SCRAP_INFESTACION
  REPARACION
}

enum EstadoLote {
  EN_PROCESO
  PAUSADO
  COMPLETADO
  CANCELADO
}

enum TipoInsumo {
  CAPUCHONES
  BASES
  TAPAS
}

enum TipoMovimiento {
  ENTRADA
  SALIDA
}

enum FaseProceso {
  REGISTRO
  TEST_INICIAL
  ENSAMBLE
  RETEST
  EMPAQUE
  SCRAP
  REPARACION
}

enum MotivoScrap {
  FUERA_DE_RANGO
  DEFECTO_SW
  SIN_REPARACION
  COSMETICA
  INFESTADO
  OTRO
}

enum DetalleScrap {
  CIRCUITO_OK_BASE_NOK
  BASE_OK_CIRCUITO_NOK
  CIRCUITO_NOK_BASE_NOK
  INFESTACION
  OTRO
}

enum TipoLote {
  ENTRADA
  SALIDA
}
