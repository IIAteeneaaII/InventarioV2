<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario Cosmético</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
</head>

<body>
  <!-- Header: título a la izquierda, usuario e iconos a la derecha -->

  <div class="app-header d-flex align-items-center justify-content-between px-4 py-3" style="background: #365a66;">
    <div class="d-flex align-items-center">
      <span style="font-size:2em; font-weight:bold; color:#fff;">Inventario de Insumos de Cosmética</span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <img src="/img/usuario.webp" alt="Usuario" class="user-icon" style="width: 40px; height: 40px; border-radius: 50%; background: #fff; border: 2px solid #fff;">
      <span class="username ms-2" style="font-size: 1.2em; font-weight: bold; color: #fff;">
        <%= user?.nombre || user?.userName || 'Usuario' %>
      </span>
      <button id="logout-icon" class="btn btn-link p-0 ms-3" title="Cerrar sesión" style="color: #fff; font-size: 1.5em;" onclick="cerrarSesion()">
  <i class="fas fa-right-from-bracket"></i>
</button>
    </div>
  </div>

  <div class="admin-container" style="background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); max-width: 1200px; margin: 40px auto;">
    <div class="h2-wrapper">
      <h2 style="text-align: center; margin-bottom: 24px;">Inventario de Insumos de Cosmética</h2>
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> Todos los SKUs disponibles se muestran automáticamente. Utilice los botones de "Entrada" para registrar stock inicial.
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-striped table-hover">
            <thead class="thead-dark">
              <tr>
                <th>Nombre SKU</th>
                <th>Capuchones</th>
                <th>Bases</th>
                <th>Tapas</th>
                <th>Total General</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <% if (Object.keys(inventario).length === 0) { %>
                <tr>
                  <td colspan="6" class="text-center">No hay datos de inventario disponibles</td>
                </tr>
              <% } else { %>
                <% Object.values(inventario).forEach(item => { 
                     const total = item.CAPUCHONES + item.BASES + item.TAPAS;
                %>
                  <tr>
                    <td><%= item.nombre || item.skuNombre || item.skuItem %></td>
                    <td id="cantidad-<%= item.skuId %>-CAPUCHONES"><%= item.CAPUCHONES %></td>
                    <td id="cantidad-<%= item.skuId %>-BASES"><%= item.BASES %></td>
                    <td id="cantidad-<%= item.skuId %>-TAPAS"><%= item.TAPAS %></td>
                    <td id="total-<%= item.skuId %>"><%= total %></td>
                    <td>
                      <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#movimientoModal"
                              data-sku-id="<%= item.skuId %>" data-tipo-movimiento="ENTRADA"
                              data-sku-nombre="<%= item.nombre || item.skuNombre || item.skuItem %>">
                        <i class="fas fa-plus"></i> Entrada
                      </button>
                      <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#movimientoModal"
                              data-sku-id="<%= item.skuId %>" data-tipo-movimiento="SALIDA"
                              data-sku-nombre="<%= item.nombre || item.skuNombre || item.skuItem %>"
                              <%= total === 0 ? 'disabled' : '' %>>
                        <i class="fas fa-minus"></i> Salida
                      </button>
                    </td>
                  </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="movimientoModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" id="modalHeader">
          <h5 class="modal-title" id="modalTitle">Registrar Movimiento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="movimientoForm">
            <input type="hidden" id="skuId" name="skuId"/>
            <input type="hidden" id="tipoMovimiento" name="tipoMovimiento"/>
            <div class="mb-3">
              <label class="form-label">SKU:</label>
              <p class="form-control-plaintext fw-bold mb-2" id="nombreSkuModal"></p>
            </div>
            <div class="mb-3">
              <label for="tipoInsumo" class="form-label">Insumo</label>
              <select class="form-select" id="tipoInsumo" name="tipoInsumo" required>
                <option value="CAPUCHONES">Capuchones</option>
                <option value="BASES">Bases</option>
                <option value="TAPAS">Tapas</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="cantidad" class="form-label">Cantidad</label>
              <input type="number" class="form-control" id="cantidad" name="cantidad" min="1" required/>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="movimientoForm" class="btn btn-primary">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</script>
<script src="/js/cerrarsesion.js"></script>
<script>
let movimientoModal;
document.addEventListener('DOMContentLoaded', function() {
  movimientoModal = new bootstrap.Modal(document.getElementById('movimientoModal'));

  // Botones de entrada/salida
  document.querySelectorAll('button[data-bs-target="#movimientoModal"]').forEach(btn => {
    btn.addEventListener('click', function() {
      const skuId = this.getAttribute('data-sku-id');
      const tipoMovimiento = this.getAttribute('data-tipo-movimiento');
      const skuNombre = this.getAttribute('data-sku-nombre');
      document.getElementById('skuId').value = skuId;
      document.getElementById('tipoMovimiento').value = tipoMovimiento;
      document.getElementById('nombreSkuModal').textContent = skuNombre;
      // Cambiar título y color del modal
      const modalTitle = document.getElementById('modalTitle');
      const modalHeader = document.getElementById('modalHeader');
      if (tipoMovimiento === 'ENTRADA') {
        modalTitle.textContent = 'Registrar Entrada de Insumos';
        modalHeader.classList.remove('bg-danger', 'text-white');
        modalHeader.classList.add('bg-success', 'text-white');
      } else {
        modalTitle.textContent = 'Registrar Salida de Insumos';
        modalHeader.classList.remove('bg-success', 'text-white');
        modalHeader.classList.add('bg-danger', 'text-white');
      }
    });
  });

  // Envío del formulario por AJAX
  document.getElementById('movimientoForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    const formData = {
      skuId: document.getElementById('skuId').value,
      tipoInsumo: document.getElementById('tipoInsumo').value,
      tipoMovimiento: document.getElementById('tipoMovimiento').value,
      cantidad: document.getElementById('cantidad').value,
    };
    try {
      const response = await fetch('/api/cosmetica/movimiento', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      const result = await response.json();
      if (response.ok && result.success) {
        Swal.fire({
          icon: 'success',
          title: '¡Éxito!',
          text: result.message,
          timer: 1500,
          showConfirmButton: false
        });
        // Actualizar la tabla
        const { skuId, tipoInsumo } = formData;
        const nuevaCantidad = result.data.cantidad;
        document.getElementById(`cantidad-${skuId}-${tipoInsumo}`).textContent = nuevaCantidad;
        // Recalcular total
        const capuchones = parseInt(document.getElementById(`cantidad-${skuId}-CAPUCHONES`).textContent);
        const bases = parseInt(document.getElementById(`cantidad-${skuId}-BASES`).textContent);
        const tapas = parseInt(document.getElementById(`cantidad-${skuId}-TAPAS`).textContent);
        const total = capuchones + bases + tapas;
        document.getElementById(`total-${skuId}`).textContent = total;
        
        // Actualizar estado del botón de salida
        const salidaBtn = document.querySelector(`button[data-sku-id="${skuId}"][data-tipo-movimiento="SALIDA"]`);
        if (salidaBtn) {
          if (total === 0) {
            salidaBtn.setAttribute('disabled', 'disabled');
          } else {
            salidaBtn.removeAttribute('disabled');
          }
        }
        
        movimientoModal.hide();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: result.message || 'Ocurrió un error al registrar el movimiento.'
        });
      }
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: 'Error de Conexión',
        text: 'No se pudo conectar con el servidor.'
      });
    }
  });
});
  
</script>

</body>
</html>