<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial de Número de Serie</title>
  <link rel="stylesheet" href="/css/admin_dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <div class="admin-container">
    <div class="h2-wrapper">
      <h2>Consultar historial de proceso</h2>
      <button id="btn-regresar" class="btn btn-regresar"><i class="fas fa-arrow-left"></i> Inicio</button>
    </div>

    <!-- Formulario de búsqueda -->
    <form class="form-busqueda-ns" method="GET" action="/historial">
      <div class="busqueda-input-wrap">
        <input 
          type="text" 
          name="sn" 
          placeholder="Ingresa número de serie" 
          value="<%= sn || '' %>" 
          required 
          class="input-ns" />
        <button type="submit" class="btn btn-primary">Buscar</button>
        <a href="/historial" class="btn btn-secondary btn-busqueda-limpiar">Limpiar</a>
      </div>
    </form>

    <!-- Info SKU debajo del buscador -->
    <% if (sn && skuNombre && (skuItem || skuId)) { %>
      <div class="sku-info" style="margin: 8px 0; font-size: 14px; color: #374151;">
        <strong>SKU:</strong> <%= skuNombre %>
        <% if (skuItem) { %> — <strong>Item:</strong> <%= skuItem %> <% } %>
        <% if (skuId) { %> — <strong>ID:</strong> <%= skuId %> <% } %>
      </div>
    <% } %>

    <% if (sn) { %>
      <% if (fasesRealizadas.length > 0) { %>
        <h2>
          Historial del módem: <%= sn %>
          <% if (skuNombre && (skuItem || skuId)) { %>
            — SKU: <%= skuNombre %>
            <% if (skuItem) { %> (Item: <%= skuItem %>) <% } %>
            <% if (skuId) { %> <% } %>
          <% } %>
        </h2>

        <div class="timeline-horizontal">
          <% const fases = ['REGISTRO', 'TEST_INICIAL', 'COSMETICA', 'ENSAMBLE', 'RETEST', 'EMPAQUE']; %>
          <% const iconMap = {
            'REGISTRO': 'registro',
            'TEST_INICIAL': 'testinicial',
            'COSMETICA': 'cosmetica',
            'ENSAMBLE': 'ensamble',
            'RETEST': 'retest',
            'EMPAQUE': 'empaque'
          }; %>

          <%
            const incluyeTestInicial = fasesRealizadas.includes('TEST_INICIAL');
            const incluyeEnsamble = fasesRealizadas.includes('ENSAMBLE');
          %>

          <% 
            // Verificar si se ha llegado a la fase de empaque
            const llegoAEmpaque = fasesRealizadas.includes('EMPAQUE');
            
            fases.forEach((fase, index) => {
            let completada = fasesRealizadas.includes(fase);
            let esActual = fasesRealizadas[fasesRealizadas.length - 1] === fase;

            // Reglas para COSMETICA
            const mostrarMorado = (fase === 'COSMETICA' && incluyeTestInicial && !incluyeEnsamble && !llegoAEmpaque);
            if (fase === 'COSMETICA' && incluyeEnsamble) {
              completada = true;
            }
            
            // Si llegó a empaque, todas las fases anteriores se marcan como completadas
            if (llegoAEmpaque && fase !== 'EMPAQUE') {
              completada = true;
              esActual = false;
            }
          %>
            <div class="timeline-item 
                        <% if (mostrarMorado) { %> morado <% } else { %>
                        <%= completada ? 'pasada' : 'omitida' %>
                        <%= esActual ? ' actual' : '' %>
                        <% } %>">
              <div class="timeline-icon">
                <img src="/img/<%= iconMap[fase] %>.png" alt="<%= fase %>">
              </div>
              <div class="timeline-label"><%= fase.replace('_', ' ') %></div>
            </div>

            <% if (index < fases.length - 1) { %>
              <div class="timeline-line <%= llegoAEmpaque ? 'empaque-completo' : '' %>"></div>
            <% } %>
          <% }) %>
        </div>

      <% } else { %>
        <p class="status-message error">
          No se encontró historial para el número de serie <strong><%= sn %></strong>.
        </p>
      <% } %>
    <% } %>

    <!-- ====== Botón flotante "Acotaciones" (no altera la lógica del buscador) ====== -->
    <button id="btn-acotaciones" class="btn btn-primary btn-acotaciones-floating" aria-haspopup="dialog" aria-controls="modalAcotaciones">
      <i class="fas fa-info-circle" style="margin-right:1px;"></i> 
    </button>
  </div>

  <!-- ====== Modal de Acotaciones ====== -->
  <div id="modalAcotaciones" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalAcotacionesTitulo" style="display:none;">
    <div class="modal-content modal-content-acotaciones">
      <span class="close-modal" id="closeAcotaciones" aria-label="Cerrar">&times;</span>
      <h3 id="modalAcotacionesTitulo" style="margin-top:0;">Descripción de Estados</h3>
      <div id="modalAcotacionesBody"><!-- Contenido compacto inyectado por JS --></div>
    </div>
  </div>

  <!-- ====== Template oculto con el contenido de Acotaciones (no se muestra en la página) ====== -->
  <template id="acotacionesTemplate">
    <div class="acotaciones-container">
      <h2>Descripción de Estados</h2>
      <ul class="acotaciones-list">
        <li class="acotacion-item">
          <img src="/img/modem_gris.png" alt="Sin procesar">
          <p>Sin Procesar.</p>
        </li>
        <li class="acotacion-item">
          <img src="/img/modem_azul.png" alt="Proceso actual">
          <p>Proceso Actual.</p>
        </li>
        <li class="acotacion-item">
          <img src="/img/modem_verde.png" alt="Procesada pasado">
          <p>Proceso Pasado.</p>
        </li>
        <li class="acotacion-item">
          <img src="/img/modem_morado.png" alt="Cosmético">
          <p>Proceso Cosmético.</p>
        </li>
        <li class="acotacion-item">
          <img src="/img/modem_rojo.png" alt="Salto de fase">
          <p>Salto en Fase de Proceso.</p>
        </li>
      </ul>
    </div>
  </template>

  <!-- ====== Script externo requerido ====== -->
  <script defer src="/js/acotaciones-modal.js"></script>

  <!-- ====== JS inline existente ====== -->
  <script>
    document.getElementById('btn-regresar').addEventListener('click', function() {
      window.location.href = '/adminventario';
    });
  </script>

  <!-- ====== Fallback inline por si aún no creas /js/acotaciones-modal.js ====== -->
  <script>
    (function () {
      const btn = document.getElementById('btn-acotaciones');
      const modal = document.getElementById('modalAcotaciones');
      const closeBtn = document.getElementById('closeAcotaciones');
      const body = document.getElementById('modalAcotacionesBody');
      const tpl = document.getElementById('acotacionesTemplate');

      function abrirModal() {
        body.innerHTML = '';
        if (tpl?.content) {
          const clon = tpl.content.cloneNode(true);
          const cont = clon.querySelector('.acotaciones-container');
          if (cont) cont.classList.add('acotaciones-compact'); // versión compacta para modal
          body.appendChild(clon);
        }
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      }

      function cerrarModal() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        body.innerHTML = '';
      }

      btn?.addEventListener('click', abrirModal);
      closeBtn?.addEventListener('click', cerrarModal);
      window.addEventListener('click', (e) => { if (e.target === modal) cerrarModal(); });
      window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display === 'block') cerrarModal(); });
    })();
  </script>
</body>
</html>
