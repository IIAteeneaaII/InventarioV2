<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta charset="UTF-8" />
  <title>Historial de Número de Serie</title>
  <link rel="stylesheet" href="/css/admin_dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- CSS principal -->
  <link rel="stylesheet" href="/css/admin_dashboard.css" />

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>

  <div class="admin-container">
    <div class="h2-wrapper">
      <h2>Consultar historial de proceso</h2>
@ -16,13 +22,14 @@
    <!-- Formulario de búsqueda -->
    <form class="form-busqueda-ns" method="GET" action="/historial">
      <div class="busqueda-input-wrap">
        <input 
          type="text" 
          name="sn" 
          placeholder="Ingresa número de serie" 
          value="<%= sn || '' %>" 
          required 
          class="input-ns" />
        <input
          type="text"
          name="sn"
          placeholder="Ingresa número de serie"
          value="<%= sn || '' %>"
          required
          class="input-ns"
        />
        <button type="submit" class="btn btn-primary">Buscar</button>
        <a href="/historial" class="btn btn-secondary btn-busqueda-limpiar">Limpiar</a>
      </div>
@ -50,41 +57,25 @@

        <div class="timeline-horizontal">
          <% const fases = ['REGISTRO', 'TEST_INICIAL', 'COSMETICA', 'ENSAMBLE', 'RETEST', 'EMPAQUE']; %>
          <% const iconMap = {
            'REGISTRO': 'registro',
            'TEST_INICIAL': 'testinicial',
            'COSMETICA': 'cosmetica',
            'ENSAMBLE': 'ensamble',
            'RETEST': 'retest',
            'EMPAQUE': 'empaque'
          }; %>
          <% const iconMap = { 'REGISTRO':'registro', 'TEST_INICIAL':'testinicial', 'COSMETICA':'cosmetica', 'ENSAMBLE':'ensamble', 'RETEST':'retest', 'EMPAQUE':'empaque' }; %>

          <%
            const incluyeTestInicial = fasesRealizadas.includes('TEST_INICIAL');
            const incluyeEnsamble = fasesRealizadas.includes('ENSAMBLE');
          %>

          <% 
            // Verificar si se ha llegado a la fase de empaque
            const llegoAEmpaque = fasesRealizadas.includes('EMPAQUE');
            
            fases.forEach((fase, index) => {
            let completada = fasesRealizadas.includes(fase);
            let esActual = fasesRealizadas[fasesRealizadas.length - 1] === fase;

            // Reglas para COSMETICA
            const mostrarMorado = (fase === 'COSMETICA' && incluyeTestInicial && !incluyeEnsamble && !llegoAEmpaque);
            if (fase === 'COSMETICA' && incluyeEnsamble) {
              completada = true;
            }
            
            // Si llegó a empaque, todas las fases anteriores se marcan como completadas
            if (llegoAEmpaque && fase !== 'EMPAQUE') {
              completada = true;
              esActual = false;
            }
              let completada = fasesRealizadas.includes(fase);
              let esActual = fasesRealizadas[fasesRealizadas.length - 1] === fase;

              const mostrarMorado = (fase === 'COSMETICA' && incluyeTestInicial && !incluyeEnsamble && !llegoAEmpaque);
              if (fase === 'COSMETICA' && incluyeEnsamble) { completada = true; }

              if (llegoAEmpaque && fase !== 'EMPAQUE') {
                completada = true;
                esActual = false;
              }
          %>
            <div class="timeline-item 
            <div class="timeline-item
                        <% if (mostrarMorado) { %> morado <% } else { %>
                        <%= completada ? 'pasada' : 'omitida' %>
                        <%= esActual ? ' actual' : '' %>
@ -100,19 +91,68 @@
            <% } %>
          <% }) %>
        </div>

      <% } else { %>
        <p class="status-message error">
          No se encontró historial para el número de serie <strong><%= sn %></strong>.
        </p>
      <% } %>
    <% } %>

    <!-- Botón flotante para ver acotaciones -->
    <button id="btn-acotaciones" class="btn btn-primary btn-acotaciones-floating" aria-haspopup="dialog" aria-controls="modalAcotaciones">
      <i class="fas fa-info-circle" style="margin-right:6px;"></i> Acotaciones
    </button>
  </div>

<script>
  document.getElementById('btn-regresar').addEventListener('click', function() {
    window.location.href = '/adminventario';
  });
</script>
  <!-- Modal de Acotaciones -->
  <div id="modalAcotaciones" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalAcotacionesTitulo">
    <div class="modal-content modal-content-acotaciones">
      <span class="close-modal" id="closeAcotaciones" aria-label="Cerrar">&times;</span>
      <h3 id="modalAcotacionesTitulo" style="margin-top:0;">Descripción de Estados</h3>
      <div id="modalAcotacionesBody"><!-- Contenido compacto inyectado por JS --></div>
    </div>
  </div>

  <!-- Template (no se muestra) con el contenido de acotaciones -->
  <template id="acotacionesTemplate">
    <div class="acotaciones-container">
      <h2>Descripción de Estados</h2>
      <ul class="acotaciones-list">
        <li class="acotacion-item">
          <img src="/img/modem_gris.png" alt="Sin procesar">
          <p>Sin Procesar.</p>
        </li>
        <li class="acotacion-item">
          <img src="/img/modem_azul.png" alt="Proceso actual">
          <p>Proceso Actual.</p>
        </li>
        <li class="acotacion-item">
          <img src="/img/modem_verde.png" alt="Procesada pasado">
          <p>Procesada Pasado.</p>
        </li>
        <li class="acotacion-item">
          <img src="/img/modem_morado.png" alt="Cosmético">
          <p>Proceso Cosmético.</p>
        </li>
        <li class="acotacion-item">
          <img src="/img/modem_rojo.png" alt="Salto de fase">
          <p>Salto en Fase de Proceso.</p>
        </li>
      </ul>
    </div>
  </template>

  <!-- Script principal (ruta solicitada) -->
  <script defer src="/js/flotante.js"></script>

  <!-- JS inline (por si aún no creas el archivo externo) -->
  <script>
    // Navegar a inicio
    document.getElementById('btn-regresar')?.addEventListener('click', function () {
      window.location.href = '/adminventario';
    });


  </script>
</body>
</html>